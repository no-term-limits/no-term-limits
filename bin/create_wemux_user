#!/usr/bin/env bash

function error_handler() {
  >&2 echo "Exited with BAD EXIT CODE '${2}' in ${0} script at line: ${1}."
  exit "$2"
}
trap 'error_handler ${LINENO} $?' ERR
set -Eeuo pipefail

# HELP: create a wemux pair user with tmux/wemux support

pair_user="${1:-}"

if [[ -z "$pair_user" ]]; then
  >&2 echo "ERROR: usage: $(basename "$0") [wemux_pair_user]"
  exit 1
fi

if [[ "$pair_user" != "$(whoami)" ]]; then
  # Use the generic user creation script with wemux command
  if [[ "${NO_TERM_LIMITS_FORCE_WEMUX:-}" != "false" ]]; then
    create_user_for_pairing "$pair_user" "/usr/local/bin/wemux pair"
  else
    create_user_for_pairing "$pair_user"
  fi

  # tmux 3.3+ requires this command but it does not exist before
  # that version so ignore the failure
  tmux server-access -a "$pair_user" || echo ''
fi
