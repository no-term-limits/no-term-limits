#!/usr/bin/env bash

function error_handler() {
  >&2 echo "Exited with BAD EXIT CODE '${2}' in ${0} script at line: ${1}."
  exit "$2"
}
trap 'error_handler ${LINENO} $?' ERR
set -Eeuo pipefail

# HELP: create a zellij pair user with zellij support

pair_user="${1:-}"

if [[ -z "$pair_user" ]]; then
  >&2 echo "ERROR: usage: $(basename "$0") [zellij_pair_user]"
  exit 1
fi

if [[ "$pair_user" != "$(whoami)" ]]; then
  # Use the generic user creation script with zellij join command
  if [[ "${NO_TERM_LIMITS_FORCE_ZELLIJ:-}" != "false" ]]; then
    create_user_for_pairing "$pair_user" "/usr/local/bin/join_pair_session"
  else
    create_user_for_pairing "$pair_user"
  fi

  # Store the original user for the join_pair_session script
  echo "$(whoami)" > /var/tmp/no_term_limits_pair_session_owner
fi